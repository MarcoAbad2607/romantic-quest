<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Romantic Quest GO</title>
  <link rel="preconnect" href="https://unpkg.com" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="anonymous">
  <style>
    :root {
      --bg:#0e0e12; --card:#171720; --ink:#f6f7fb; --muted:#b3b8c4; --acc:#ffd54d;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial,sans-serif;background:var(--bg);color:var(--ink)}
    header{padding:16px 20px;border-bottom:1px solid #242438;position:sticky;top:0;background:linear-gradient(#111,#0e0e12)}
    h1{margin:0;font-size:18px}
    #map{height:46vh}
    .wrap{padding:16px}
    .card{background:var(--card);border:1px solid #242438;border-radius:14px;padding:14px;margin:12px 0}
    .flex{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    .btn{appearance:none;border:0;border-radius:10px;padding:10px 14px;font-weight:600;background:#3a3af6;color:white}
    .btn.secondary{background:#2a2a39}
    .btn:disabled{opacity:.5}
    .tag{font-size:12px;padding:4px 8px;border-radius:999px;background:#23233a;color:#cfd3e6}
    .pill{background:#1b1b28;padding:8px 10px;border-radius:12px}
    .grid{display:grid;grid-template-columns:1fr auto;gap:8px;align-items:center}
    .progress{height:8px;background:#242438;border-radius:999px;overflow:hidden}
    .bar{height:100%;background:linear-gradient(90deg,#3a3af6,#9a66ff);width:0%}
    .stop{display:flex;justify-content:space-between;align-items:center;padding:10px;border-radius:10px;background:#141422}
    .stop .meta{font-size:12px;color:var(--muted)}
    .found{opacity:.6}
    .final{border:2px solid var(--acc)}
    .footer-note{color:var(--muted);font-size:12px;margin-top:8px}
    img.card-img{width:100%;border-radius:12px;margin-top:8px}
    .big{font-size:18px}
  </style>
</head>
<body>
<header>
  <h1>Romantic Quest GO ‚ú®</h1>
</header>

<div id="map"></div>

<div class="wrap">
  <div class="card">
    <div class="grid">
      <div>
        <div class="big">Progreso</div>
        <div class="footer-note" id="progressText">0 de 0 cartas</div>
      </div>
      <button id="startBtn" class="btn">Iniciar GPS</button>
    </div>
    <div class="progress" style="margin-top:10px"><div id="bar" class="bar"></div></div>
  </div>

  <div id="stopsList"></div>

  <div id="finalCard" class="card final" style="display:none;">
    <div class="flex">
      <span class="tag">¬°√öltima misi√≥n desbloqueada!</span>
    </div>
    <p id="finalMsg" style="margin:8px 0 0 0;"></p>
    <a id="finalLink" class="btn" target="_blank" rel="noopener">Abrir ubicaci√≥n final</a>
  </div>

  <p class="footer-note">Consejo: si iPhone no te centra en el mapa, toca ‚ÄúIniciar GPS‚Äù y acepta permisos.</p>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin="anonymous"></script>
<script>
/* ========= CONFIGURA TUS PARADAS AQU√ç =========
  - lat, lng: coordenadas
  - radius: metros para permitir ‚ÄúAtrapar carta‚Äù
  - title: nombre visible
  - message: el mensaje de la carta
  - image: URL opcional (sube a tu hosting o usa una p√∫blica)
*/
const STOPS = [
  { id:"cafe", lat: 20.5935, lng: -100.3923, radius: 60,
    title:"Nuestra primera charla ‚òï",
    message:"Aqu√≠ comenz√≥ a escribirse esta historia. Gracias por ese caf√© y por tu risa.",
    image:"" },
  { id:"parque", lat: 20.6008, lng: -100.3890, radius: 60,
    title:"El parque de las risas üå≥",
    message:"Prometo m√°s caminatas, m√°s chistes malos y m√°s fotos robadas tuyas.",
    image:"" },
  { id:"cine", lat: 20.5871, lng: -100.3899, radius: 60,
    title:"Butacas c√≥mplices üé¨",
    message:"La pel√≠cula fue buena, pero tu mano en la m√≠a fue mejor.",
    image:"" }
];

/* ========= MENSAJE Y UBICACI√ìN FINAL ========= */
const FINAL_DESTINATION = {
  lat: 20.5899, lng: -100.3881,
  text: "Has reunido todas las cartas. Hay una √∫ltima sorpresa esperando por ti‚Ä¶ ¬øVienes? üíõ",
  linkText: "Navegar al destino final",
  // El enlace de Apple/Google Maps se genera m√°s abajo con estas coords.
};

/* ========= FIN DE CONFIG ========= */

const STORAGE_KEY = "rqg_progress_v1";
let found = new Set(JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]"));

const map = L.map('map', { zoomControl:true });
const tiles = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'¬© OpenStreetMap'});
tiles.addTo(map);

const markers = {};
function initMapView() {
  if (STOPS.length) {
    const group = L.featureGroup();
    STOPS.forEach(s => group.addLayer(L.marker([s.lat, s.lng])));
    group.addLayer(L.marker([FINAL_DESTINATION.lat, FINAL_DESTINATION.lng]));
    group.addTo(map);
    map.fitBounds(group.getBounds().pad(0.25));
  } else {
    map.setView([0,0],2);
  }
}
initMapView();

// Render UI
const stopsList = document.getElementById('stopsList');
function fmtMeters(m){ return m<1000 ? `${Math.round(m)} m` : `${(m/1000).toFixed(2)} km`; }
function renderStops(distanceMap = {}) {
  stopsList.innerHTML = "";
  STOPS.forEach(s => {
    const isFound = found.has(s.id);
    const d = distanceMap[s.id];
    const canCatch = d != null && d <= s.radius;
    const div = document.createElement('div');
    div.className = "card stop" + (isFound ? " found" : "");
    div.innerHTML = `
      <div>
        <div><strong>${s.title}</strong></div>
        <div class="meta">Radio: ${s.radius} m ¬∑ ${d!=null?`Distancia: ${fmtMeters(d)}`:""}</div>
        <div class="meta">${isFound ? "‚úÖ Carta atrapada" : "Pendiente"}</div>
        ${isFound && s.image ? `<img class="card-img" src="${s.image}" alt="">` : ""}
        ${isFound ? `<div class="pill">${s.message}</div>` : ""}
      </div>
      <div>
        <button data-id="${s.id}" class="btn" ${isFound || !canCatch ? "disabled":""}>
          Atrapar carta
        </button>
      </div>`;
    stopsList.appendChild(div);
  });

  // progreso
  const got = found.size, total = STOPS.length;
  document.getElementById('progressText').textContent = `${got} de ${total} cartas`;
  document.getElementById('bar').style.width = (total? (100*got/total):0) + "%";

  // final
  const showFinal = (found.size === STOPS.length);
  const finalCard = document.getElementById('finalCard');
  finalCard.style.display = showFinal ? "block" : "none";
  if (showFinal) {
    document.getElementById('finalMsg').textContent = FINAL_DESTINATION.text;
    const finalUrlApple = `http://maps.apple.com/?daddr=${FINAL_DESTINATION.lat},${FINAL_DESTINATION.lng}&dirflg=d`;
    const finalUrlGoogle = `https://www.google.com/maps/dir/?api=1&destination=${FINAL_DESTINATION.lat},${FINAL_DESTINATION.lng}`;
    const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
    const link = document.getElementById('finalLink');
    link.textContent = FINAL_DESTINATION.linkText;
    link.href = isIOS ? finalUrlApple : finalUrlGoogle;
  }
}
renderStops();

// catch handler
stopsList.addEventListener('click', (e)=>{
  const btn = e.target.closest('button[data-id]');
  if(!btn) return;
  const id = btn.getAttribute('data-id');
  if (found.has(id)) return;
  found.add(id);
  localStorage.setItem(STORAGE_KEY, JSON.stringify([...found]));
  // peque√±a animaci√≥n simple
  btn.textContent = "¬°Capturada!";
  btn.disabled = true;
  renderStops(lastDistances);
});

// distance calculation
function haversine(lat1, lon1, lat2, lon2) {
  const R = 6371000;
  const toRad = x => x * Math.PI/180;
  const dLat = toRad(lat2-lat1);
  const dLon = toRad(lon2-lon1);
  const a = Math.sin(dLat/2)**2 +
            Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*
            Math.sin(dLon/2)**2;
  return 2 * R * Math.asin(Math.sqrt(a));
}

let watchId = null;
let lastDistances = {};

function updateDistances(pos){
  const { latitude:lat, longitude:lng } = pos.coords;
  // centrar suavemente la primera vez
  if (!updateDistances._centered) {
    map.setView([lat,lng], 16);
    updateDistances._centered = true;
  }
  // marcador del usuario
  if (!markers.me){
    markers.me = L.circleMarker([lat,lng],{radius:8,weight:2,color:'#3a3af6'}).addTo(map);
  } else {
    markers.me.setLatLng([lat,lng]);
  }
  // actualizar distancias
  const d = {};
  STOPS.forEach(s => d[s.id] = haversine(lat,lng,s.lat,s.lng));
  lastDistances = d;
  renderStops(d);
}

function startGPS(){
  if(!('geolocation' in navigator)){
    alert("Tu navegador no permite geolocalizaci√≥n.");
    return;
  }
  if (watchId!=null) return; // ya corriendo
  watchId = navigator.geolocation.watchPosition(updateDistances, (err)=>{
    console.warn(err);
    alert("No se pudo obtener tu ubicaci√≥n. Revisa permisos de ubicaci√≥n.");
  }, {
    enableHighAccuracy:true,
    maximumAge: 5000,
    timeout: 15000
  });
}

document.getElementById('startBtn').addEventListener('click', startGPS);
</script>
</body>
</html>
