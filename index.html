<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>Romantic Quest GO ‚Äì AR</title>
<style>
  html,body{margin:0;height:100%;background:#0b0b10;color:#fff;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
  header{padding:12px 16px;border-bottom:1px solid #1e1e2a;background:#0f0f16;position:sticky;top:0;z-index:3}
  h1{margin:0;font-size:18px}
  .wrap{padding:12px 16px}
  .btn{background:#3a3af6;color:#fff;border:0;border-radius:12px;padding:10px 14px;font-weight:600}
  .btn.secondary{background:#23233a}
  #videoWrap{position:relative; width:100%; max-width:420px; margin:12px auto; border-radius:16px; overflow:hidden; background:#000}
  video{width:100%; height:auto; display:block; transform:scaleX(-1);} /* espejo para estilo AR */
  canvas{position:absolute; left:0; top:0; width:100%; height:100%; touch-action:none;}
  .card{background:#151527;border:1px solid #252545;border-radius:14px;padding:12px;margin:12px 0}
  .tag{font-size:12px;background:#23233a;color:#cfd3e6;padding:4px 8px;border-radius:999px}
  .row{display:flex; gap:8px; flex-wrap:wrap}
  .progress{height:8px;background:#23233a;border-radius:999px;overflow:hidden}
  .bar{height:100%;background:linear-gradient(90deg,#3a3af6,#9a66ff);width:0%}
</style>
</head>
<body>
<header><h1>Romantic Quest GO ‚ú® ‚Äì AR Catch</h1></header>

<div class="wrap">
  <div class="card">
    <div class="row">
      <button id="cameraBtn" class="btn">Abrir c√°mara</button>
      <button id="spawnBtn" class="btn secondary" disabled>Mostrar carta</button>
      <button id="throwHintBtn" class="btn secondary" disabled>C√≥mo lanzar</button>
    </div>
    <div class="progress"><div id="bar" class="bar"></div></div>
    <div style="font-size:12px;opacity:.8;margin-top:6px">Permite c√°mara. Desliza desde abajo a arriba para lanzar la HeartBall ‚ù§Ô∏è</div>
  </div>

  <div id="videoWrap">
    <video id="vid" playsinline muted></video>
    <canvas id="cv"></canvas>
  </div>

  <div class="card">
    <span class="tag">Parada actual</span>
    <div id="stopTitle" style="margin-top:6px;font-weight:700">Carta: ‚ÄúNuestra primera charla ‚òï‚Äù</div>
    <div id="stopMsg" style="opacity:.85;margin-top:6px">Atr√°pala en AR para desbloquear el mensaje.</div>
  </div>

  <div id="caughtCard" class="card" style="display:none">
    <span class="tag">‚úÖ ¬°Capturada!</span>
    <p id="caughtText" style="margin-top:8px"></p>
  </div>
</div>

<script>
/* -------- Configurable (puedes rotar varias cartas si quieres) -------- */
const CARD_DATA = {
  id: "cafe",
  title: "Nuestra primera charla ‚òï",
  message: "Aqu√≠ comenz√≥ todo. Gracias por ese caf√© y por tu risa.",
};
/* --------------------------------------------------------------------- */

const vid = document.getElementById('vid');
const cv = document.getElementById('cv');
const ctx = cv.getContext('2d');
const cameraBtn = document.getElementById('cameraBtn');
const spawnBtn = document.getElementById('spawnBtn');
const throwHintBtn = document.getElementById('throwHintBtn');
const bar = document.getElementById('bar');
const stopTitle = document.getElementById('stopTitle');
const stopMsg = document.getElementById('stopMsg');
const caughtCard = document.getElementById('caughtCard');
const caughtText = document.getElementById('caughtText');

stopTitle.textContent = `Carta: ‚Äú${CARD_DATA.title}‚Äù`;

let streamStarted = false;
let W=0,H=0, DPR = Math.max(1, window.devicePixelRatio||1);

/* Estado del juego */
let game = {
  target: null, // carta
  ball: null,   // HeartBall
  gravity: 1200, // px/s^2
  caught: false,
  t0: 0,
  last: 0,
  swipe: {active:false,sx:0,sy:0,ex:0,ey:0},
  sparkles: []
};

/* HeartBall y Carta */
function spawnTarget(){
  // posici√≥n al azar en la mitad superior
  const w = W*0.34, h = w*0.62; // proporci√≥n tipo carta
  const x = Math.random()*(W - w) * 0.9 + W*0.05;
  const y = H*0.12 + Math.random()*H*0.15;
  game.target = {x,y,w,h, wobble:0};
  game.caught = false;
  caughtCard.style.display = "none";
  stopMsg.textContent = "Desliza para lanzar la HeartBall ‚ù§Ô∏è y atraparla.";
}

function spawnBall(){
  const r = Math.max(22, W*0.055);
  game.ball = {
    x: W*0.5, y: H*0.85,
    r,
    vx: 0, vy: 0,
    flying: false
  };
}

function resize(){
  const rect = vid.getBoundingClientRect();
  W = Math.floor(rect.width);
  H = Math.floor(rect.height || W*1.6);
  cv.width = Math.floor(W*DPR);
  cv.height= Math.floor(H*DPR);
  cv.style.width = W+'px';
  cv.style.height= H+'px';
  ctx.setTransform(DPR,0,0,DPR,0,0);
}
window.addEventListener('resize', resize);

/* C√°mara */
async function startCamera(){
  try{
    const s = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: "environment" }, audio:false
    });
    vid.srcObject = s;
    await vid.play();
    streamStarted = true;
    resize();
    spawnBtn.disabled = false;
    throwHintBtn.disabled = false;
  }catch(e){
    alert("No se pudo acceder a la c√°mara. Aseg√∫rate de permitir el acceso y estar en HTTPS.");
  }
}

cameraBtn.addEventListener('click', startCamera);
spawnBtn.addEventListener('click', ()=>{ spawnTarget(); spawnBall(); });
throwHintBtn.addEventListener('click', ()=>{
  alert("Consejo: toca cerca de la bola y desliza hacia la carta. Mientras m√°s largo y recto el swipe, m√°s r√°pido va.");
});

/* Inputs (toque/arrastre) */
cv.addEventListener('pointerdown', e=>{
  if(!game.ball) return;
  const rect = cv.getBoundingClientRect();
  const x = e.clientX - rect.left, y = e.clientY - rect.top;
  const dx = x - game.ball.x, dy = y - game.ball.y;
  if(dx*dx + dy*dy <= game.ball.r*game.ball.r*1.8){ // tocar cerca
    game.swipe = {active:true,sx:x,sy:y,ex:x,ey:y};
  }
});
cv.addEventListener('pointermove', e=>{
  if(!game.swipe.active) return;
  const rect = cv.getBoundingClientRect();
  game.swipe.ex = e.clientX - rect.left;
  game.swipe.ey = e.clientY - rect.top;
});
cv.addEventListener('pointerup', ()=>{
  if(!game.swipe.active || !game.ball || game.ball.flying) { game.swipe.active=false; return; }
  const dx = game.swipe.ex - game.swipe.sx;
  const dy = game.swipe.ey - game.swipe.sy;
  const mag = Math.hypot(dx,dy);
  if(mag < 12){ game.swipe.active=false; return; }
  // lanzar: invertimos Y (arriba negativo en swipe ‚Üí arriba positivo en vy negativo)
  const power = Math.min(1.0, mag/220);
  const ang = Math.atan2(dy, dx);
  const speed = 1200 * power; // px/s
  game.ball.vx = Math.cos(ang)*speed;
  game.ball.vy = Math.sin(ang)*speed;
  // si fue swipe hacia arriba, la vy ser√° negativa; bien.
  game.ball.flying = true;
  game.swipe.active = false;
});

/* F√≠sica + Dibujo */
function step(ts){
  if(!game.t0) game.t0 = ts;
  const dt = Math.min(0.033, (ts - game.last)/1000 || 0);
  game.last = ts;
  draw(dt);
  requestAnimationFrame(step);
}

function draw(dt){
  ctx.clearRect(0,0,W,H);

  // Dibujar target (carta)
  if(game.target){
    game.target.wobble += dt*3;
    const bump = Math.sin(game.target.wobble)*4;
    const {x,y,w,h} = game.target;
    // carta base
    roundRect(ctx, x, y + bump, w, h, 14, "#ffd54d", "#28283a");
    // ‚Äúarte‚Äù de la carta
    ctx.fillStyle = "#1b1b28";
    ctx.fillRect(x+10, y+10 + bump, w-20, h*0.55);
    // t√≠tulo
    ctx.fillStyle = "#111";
    ctx.globalAlpha = 0.85;
    ctx.fillRect(x, y + h*0.62 + bump, w, 28);
    ctx.globalAlpha = 1;
    ctx.fillStyle = "#fff";
    ctx.font = "600 14px system-ui,-apple-system,Segoe UI,Roboto";
    ctx.fillText(CARD_DATA.title, x+12, y + h*0.62 + 19 + bump);
  }

  // Bola
  if(game.ball){
    if(game.ball.flying){
      game.ball.vy += game.gravity*dt;
      game.ball.x += game.ball.vx*dt;
      game.ball.y += game.ball.vy*dt;
    }
    // rebotes simples laterales
    if(game.ball.x < game.ball.r){ game.ball.x = game.ball.r; game.ball.vx *= -0.4; }
    if(game.ball.x > W - game.ball.r){ game.ball.x = W - game.ball.r; game.ball.vx *= -0.4; }
    // suelo
    if(game.ball.y > H - game.ball.r){
      game.ball.y = H - game.ball.r;
      game.ball.vy *= -0.35;
      game.ball.vx *= 0.96;
      if(Math.abs(game.ball.vy) < 60) { game.ball.vy = 0; game.ball.flying=false; }
    }

    drawBall(ctx, game.ball.x, game.ball.y, game.ball.r);

    // L√≠nea de swipe (si est√° arrastrando)
    if(game.swipe.active){
      ctx.strokeStyle = "rgba(255,255,255,.5)";
      ctx.lineWidth = 2;
      ctx.beginPath();
      ctx.moveTo(game.swipe.sx, game.swipe.sy);
      ctx.lineTo(game.swipe.ex, game.swipe.ey);
      ctx.stroke();
    }
  }

  // Colisi√≥n con carta (AABB vs punto del centro de la bola)
  if(game.ball && game.target && !game.caught){
    const b = game.ball, t = game.target;
    if(b.x > t.x && b.x < t.x + t.w && b.y > t.y && b.y < t.y + t.h){
      game.caught = true;
      explode(t.x+t.w/2, t.y+t.h/2);
      onCaught();
    }
  }

  // Part√≠culas
  for(let i=game.sparkles.length-1;i>=0;i--){
    const s = game.sparkles[i];
    s.vy += 300*dt;
    s.x += s.vx*dt; s.y += s.vy*dt;
    s.life -= dt;
    if(s.life<=0) { game.sparkles.splice(i,1); continue; }
    ctx.globalAlpha = Math.max(0, s.life/s.max);
    ctx.beginPath(); ctx.arc(s.x,s.y, s.r, 0, Math.PI*2); ctx.fillStyle = "#ffd54d"; ctx.fill();
    ctx.globalAlpha = 1;
  }
}

function onCaught(){
  stopMsg.textContent = "¬°Carta capturada! üíõ";
  caughtText.textContent = CARD_DATA.message;
  caughtCard.style.display = "block";
  // progreso (simbolizamos 1/1 para demo)
  bar.style.width = "100%";
  // desaparecer carta despu√©s de un momento
  setTimeout(()=>{ game.target=null; }, 500);
}

function drawBall(ctx,x,y,r){
  // esfera base
  ctx.beginPath(); ctx.arc(x,y,r,0,Math.PI*2); ctx.fillStyle="#ff5a7a"; ctx.fill();
  // coraz√≥n
  ctx.save(); ctx.translate(x,y-2);
  ctx.fillStyle="#fff";
  heartPath(ctx, r*0.38); ctx.fill();
  ctx.restore();
  // brillo
  ctx.beginPath(); ctx.arc(x-r*0.35,y-r*0.35, r*0.22,0,Math.PI*2); ctx.fillStyle="rgba(255,255,255,.5)"; ctx.fill();
}

function heartPath(ctx, s){
  ctx.beginPath();
  ctx.moveTo(0, s*0.6);
  ctx.bezierCurveTo(-s, -s*0.2, -s*0.9, -s, 0, -s*0.6);
  ctx.bezierCurveTo(s*0.9, -s, s, -s*0.2, 0, s*0.6);
}

function roundRect(ctx,x,y,w,h,r,stroke="#fff",fill="#000"){
  ctx.lineWidth=2;
  ctx.fillStyle=fill; ctx.strokeStyle=stroke;
  ctx.beginPath();
  ctx.moveTo(x+r,y);
  ctx.arcTo(x+w,y, x+w,y+h, r);
  ctx.arcTo(x+w,y+h, x,y+h, r);
  ctx.arcTo(x,y+h, x,y, r);
  ctx.arcTo(x,y, x+w,y, r);
  ctx.closePath(); ctx.fill(); ctx.stroke();
}

function explode(x,y){
  for(let i=0;i<36;i++){
    game.sparkles.push({
      x,y,
      vx:(Math.random()*2-1)*220,
      vy:(Math.random()*2-1)*220,
      r: 2+Math.random()*3,
      life:.6+Math.random()*.5,
      max:1.1
    });
  }
}

/* Loop */
requestAnimationFrame(step);

/* Ajustar canvas cuando el video tenga dimensiones */
vid.addEventListener('loadedmetadata', resize);
</script>
</body>
</html>
