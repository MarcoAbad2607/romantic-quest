<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Amor GO</title>

  <!-- Mapbox GL JS v2.15 (compatible iPhone) -->
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet">
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>

  <style>
    :root { --bg:#0e0e12; --card:#171720; --ink:#0b0b0b; --muted:#5a5f6f; --acc:#ffd54d; }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial,sans-serif;background:#0e0e12;color:#f6f7fb}
    header{padding:16px 20px calc(16px + env(safe-area-inset-top));border-bottom:1px solid #242438;position:sticky;top:0;background:linear-gradient(#111,#0e0e12);z-index:2}
    h1{margin:0;font-size:18px;color:#f6f7fb}

    /* Mapa: ocupar√° toda la pantalla al iniciar juego */
    #map{height:70vh}

    .wrap{padding:16px}
    .card{background:#171720;border:1px solid #242438;border-radius:14px;padding:14px;margin:12px 0;color:#f6f7fb}
    .flex{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .btn{appearance:none;border:0;border-radius:10px;padding:12px 16px;font-weight:700;background:#3a3af6;color:white;cursor:pointer}
    .btn.secondary{background:#2a2a39}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .tag{font-size:12px;padding:4px 8px;border-radius:999px;background:#23233a;color:#cfd3e6}
    .pill{background:#1b1b28;padding:8px 10px;border-radius:12px}
    .grid{display:grid;grid-template-columns:1fr auto;gap:8px;align-items:center}
    .progress{height:8px;background:#242438;border-radius:999px;overflow:hidden}
    .bar{height:100%;background:linear-gradient(90deg,#3a3af6,#9a66ff);width:0%}
    .stop{display:flex;justify-content:space-between;align-items:center;gap:10px;padding:12px;border-radius:12px;background:#141422}
    .stop .meta{font-size:12px;color:#b3b8c4}
    .found{opacity:.6}
    .final{border:2px solid var(--acc)}
    .footer-note{color:#b3b8c4;font-size:12px;margin:12px 0 32px}
    .big{font-size:18px}
    .btns{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end}

    /* Avatar con ‚Äúpasitos‚Äù */
    @keyframes avatar-walk-bob { 0%{transform:translateY(0) rotate(var(--rot,0deg))} 50%{transform:translateY(-4px) rotate(var(--rot,0deg))} 100%{transform:translateY(0) rotate(var(--rot,0deg))} }
    @keyframes avatar-idle-breathe { 0%{transform:scale(1) rotate(var(--rot,0deg))} 50%{transform:scale(1.02) rotate(var(--rot,0deg))} 100%{transform:scale(1) rotate(var(--rot,0deg))} }
    .avatar-wrap{ width:100px; height:100px; transform:translate(-50%,-50%) }
    .avatar{ width:100px; height:100px; transform-origin:50% 50%; filter:drop-shadow(0 1px 2px rgba(0,0,0,.35)) }
    .avatar.walk{ animation:avatar-walk-bob var(--stepDur,480ms) infinite ease-in-out }
    .avatar.idle{ animation:avatar-idle-breathe 2.6s infinite ease-in-out; opacity:.98 }

    /* Overlay c√°mara + juego */
    #camOverlay{position:fixed;inset:0;background:#000;display:none;z-index:9999}
    #camVideo{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;}
    #camCanvas{position:absolute;left:0;top:0;width:100%;height:100%;touch-action:none}
    #camTopBar{position:absolute;top:0;left:0;right:0;display:flex;gap:8px;justify-content:flex-end;padding:10px calc(10px + env(safe-area-inset-right)) 10px calc(10px + env(safe-area-inset-left));background:linear-gradient(180deg,rgba(0,0,0,.55),rgba(0,0,0,0))}
    #closeCam,#throwHintBtn{background:#2a2a39;color:#fff;border:0;border-radius:10px;padding:10px 14px;font-weight:600}
    #camHint{position:absolute;left:50%;bottom:calc(16px + env(safe-area-inset-bottom));transform:translateX(-50%);color:#fff;font-size:14px;background:rgba(0,0,0,.35);padding:8px 12px;border-radius:10px}

    /* avisos */
    #msgBar{position:fixed;left:12px;right:12px;bottom:calc(12px + env(safe-area-inset-bottom));z-index:10000;background:#1b1b28;border:1px solid #2a2a3a;border-radius:12px;color:#fff;padding:10px 12px;display:none}

    /* Modal de premio */
    #rewardModal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:10001}
    #rewardModal .backdrop{position:absolute;inset:0;background:rgba(0,0,0,.55)}
    #rewardModal .content{position:relative;max-width:420px;margin:16px;background:#141422;border:1px solid #2a2a3a;border-radius:16px;padding:16px;color:#fff}
    #rewardModal img{width:100%;border-radius:12px;margin:8px 0}
    #rewardModal .row{display:flex;gap:8px;justify-content:flex-end}

    /* Pantalla completa (fallback iOS) */
    body.is-fs header, body.is-fs .wrap{display:none}
    body.is-fs #map{ position:fixed; inset:0; height:100vh!important; width:100vw!important; z-index:9990 }
    body.is-fs .fs-exit{ position:fixed; top:12px; right:12px; z-index:9991; background:#2a2a39; color:#fff; border:0; border-radius:10px; padding:10px 14px; font-weight:600; display:block }
    .fs-exit{display:none}

    /* === PANTALLA INICIAL === */
    #landingOverlay{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;flex-direction:column;gap:14px;background:radial-gradient(1200px 600px at 50% 0%, #161624, #0e0e12);z-index:10002}
    #landingOverlay .title{font-size:32px;font-weight:900;letter-spacing:.5px;color:#fff}
    #landingOverlay .subtitle{opacity:.9;color:#eaeaf3}
    #landingOverlay .actions{display:flex;gap:10px;flex-wrap:wrap}
    #landingOverlay .hint{font-size:12px;color:#c9cde0}

    /* Caja de instrucciones en landing */
    #landingOverlay .howBox{max-width:720px;margin:0 16px;background:#141422;border:1px solid #2a2a3a;border-radius:16px;padding:14px;color:#eaeaf3}
    #landingOverlay .howBox h3{margin:0 0 6px 0}
    #landingOverlay .howBox ol{margin:6px 0 0 18px; padding:0}

    /* === MARCADORES PERSONALIZADOS + POPUPS === */
    .marker{width:38px;height:38px;border-radius:14px;border:2px solid #fff;box-shadow:0 6px 16px rgba(0,0,0,.35);display:grid;place-items:center}
    .marker-stop{background:linear-gradient(180deg,#5a7dff,#3a3af6)}
    .marker-final{background:linear-gradient(180deg,#ffd54d,#ffb300)}
    .marker svg{display:block}
    .marker .ico{filter:drop-shadow(0 1px 2px rgba(0,0,0,.35))}
    .popup-darktext .mapboxgl-popup-content{background:#fff;color:#000;font-weight:600}
    .popup-darktext .mapboxgl-popup-content .popup-sub{font-weight:500;opacity:.8;margin-top:2px}
    .popup-darktext .mapboxgl-popup-tip{border-top-color:#fff!important;border-bottom-color:#fff!important}

    /* === AVISO DE SEGURIDAD (tipo Pok√©mon GO) === */
    #safetyOverlay{position:fixed;inset:0;background:rgba(0,0,0,.8);display:none;align-items:center;justify-content:center;z-index:10003}
    #safetyOverlay .box{max-width:540px;margin:16px;background:#141422;border:1px solid #2a2a3a;border-radius:18px;overflow:hidden}
    #safetyOverlay img{display:block;width:100%;height:auto}
    #safetyOverlay .inner{padding:16px;color:#eaeaf3}
    #safetyOverlay h3{margin:0 0 6px 0}
    #safetyOverlay p{margin:0 0 12px 0;opacity:.9}
  </style>
</head>
<body>
<header>
  <h1>Armando GO ‚ú®</h1>
</header>

<!-- Bot√≥n de salida (visible solo en fallback de pantalla completa) -->
<button id="fsExitBtn" class="fs-exit">Salir de pantalla completa</button>

<!-- LANDING: pantalla inicial -->
<div id="landingOverlay">
  <div class="title">Armando GO</div>
  <div class="subtitle">Un juego hecho especialmente para ti: Armando üíõ</div>

  <div class="howBox">
    <h3>¬øC√≥mo se juega?</h3>
    <ol>
      <li>Presiona <strong>Iniciar juego</strong> y acepta el aviso de seguridad.</li>
      <li>Concede permisos de <strong>ubicaci√≥n</strong> y camina hacia las paradas.</li>
      <li>Cuando est√©s dentro del radio, el juego te sugerir√° <strong>atrapar el regalo</strong>.</li>
      <li>Junta todos los regalos para revelar la <strong>sorpresa final</strong>.</li>
    </ol>
    <div id="routePreview" class="footer-note" style="margin-top:10px"></div>
  </div>

  <div class="actions">
    <button id="landingStartBtn" class="btn">Iniciar juego</button>
  </div>
  <div class="hint">Se solicitar√°n permisos de ubicaci√≥n y c√°mara al comenzar.</div>
</div>

<!-- AVISO DE SEGURIDAD -->
<div id="safetyOverlay">
  <div class="box">
    <img src="models/safety_walk.png" alt="Mantente alerta al caminar" onerror="this.src='data:image/svg+xml;charset=utf8,'+encodeURIComponent('<svg xmlns=\'http://www.w3.org/2000/svg\' width=\'960\' height=\'540\'><rect width=\'100%\' height=\'100%\' fill=\'#222\'/><text x=\'50%\' y=\'50%\' fill=\'#fff\' font-size=\'28\' text-anchor=\'middle\'>Mantente alerta al caminar</text></svg>')">
    <div class="inner">
      <h3>¬°Mantente alerta al caminar Amor! üö∂‚Äç‚ôÄÔ∏èüö∂‚Äç‚ôÇÔ∏è</h3>
      <p>Te quiero vivo Armando. Presta atenci√≥n a tu entorno. No uses el tel√©fono en v√≠as, escaleras o al cruzar calles. Juega con precauci√≥n.</p>
      <div class="flex" style="justify-content:flex-end">
        <button id="safetyOkBtn" class="btn">Entendido, jugar con cuidado</button>
      </div>
    </div>
  </div>
</div>

<div id="map"></div>

<div class="wrap" id="uiPanel">
  <div class="card">
    <div class="grid">
      <div>
        <div class="big">Progreso</div>
        <div class="footer-note" id="progressText">0 de 0 regalos</div>
      </div>
      <div class="flex">
        <button id="startBtn" class="btn" title="Iniciar GPS">Iniciar GPS</button>
        <button id="walkBtn" class="btn secondary" title="Vista tipo caminar">Modo caminata</button>
        <button id="fsBtn" class="btn secondary" title="Pantalla completa">Pantalla completa</button>
        <button id="resetBtn" class="btn secondary" title="Borrar regalos">Reiniciar</button>
      </div>
    </div>
    <div class="progress" style="margin-top:10px"><div id="bar" class="bar"></div></div>
  </div>

  <div id="stopsList"></div>

  <div id="finalCard" class="card final" style="display:none;">
    <div class="flex"><span class="tag">¬°√öltima misi√≥n desbloqueada!</span></div>
    <p id="finalMsg" style="margin:8px 0 0 0;"></p>
    <a id="finalLink" class="btn" target="_blank" rel="noopener">Abrir ubicaci√≥n final</a>
  </div>

  <!-- Galer√≠a de cupones -->
  <div id="galleryCard" class="card" style="display:none;">
    <div class="grid">
      <div>
        <div class="big">Mis cupones</div>
        <div class="footer-note" id="galleryInfo">0 guardados</div>
      </div>
      <div class="btns">
        <button id="clearGalleryBtn" class="btn secondary" title="Borrar todos">Borrar todo</button>
      </div>
    </div>
    <div id="galleryList" style="margin-top:10px; display:grid; gap:10px;"></div>
  </div>

  <p class="footer-note">
    Tip: si algo no carga, abre con <code>?v=8</code> para forzar recarga (cach√©).
  </p>
</div>

<!-- Overlay de c√°mara con juego de captura -->
<div id="camOverlay">
  <video id="camVideo" autoplay playsinline muted></video>
  <canvas id="camCanvas"></canvas>
  <div id="camTopBar">
    <button id="closeCam">Cerrar</button>
    <button id="throwHintBtn">¬øC√≥mo lanzar?</button>
  </div>
  <div id="camHint">Toca cerca de la bola y desliza hacia el regalo para lanzarla ‚ù§Ô∏è</div>
</div>

<!-- avisos -->
<div id="msgBar"></div>

<!-- Modal de premio -->
<div id="rewardModal">
  <div class="backdrop"></div>
  <div class="content">
    <h3 id="rewardTitle" style="margin:0 0 8px 0;">¬°Premio desbloqueado!</h3>
    <p id="rewardText" style="opacity:.9;margin:6px 0 10px 0;"></p>
    <img id="rewardImg" alt="Premio">
    <div class="row">
      <button id="rewardSavePhotosBtn" class="btn">Guardar cup√≥n</button>
      <button id="rewardCloseBtn" class="btn secondary">Cerrar</button>
    </div>

  </div>
</div>

<script>
/* ========= CONFIG ========= */
mapboxgl.accessToken = 'pk.eyJ1IjoibWFyY29hYmFkMjYwNyIsImEiOiJjbWU0YjllMDIwMTRkMm1vcTRicmtwdDhhIn0.izoTZ1V7LrpiqPHIRzJo8Q';

const STOPS = [
  { id:"plaza",   name:"Plaza Puerta la Victoria", lat: 20.5861, lng: -100.3814, radius: 50000,
    title:"Cine üé¨ ",
    message:"Aqu√≠ es donde me empec√© a enamorar. Gracias por esta salida.",
    camImg:"models/regalo1.png" },
  { id:"alameda", name:"Alameda", lat: 20.5866, lng: -100.3873, radius: 120,
    title:"El parque de las risas üå≥",
    message:"Prometo m√°s salidas como esta.",
    camImg:"models/regalo2.png" },
  { id:"maniatica", name:"Maniatica", lat: 20.5929, lng: -100.3921, radius: 120,
    title:"Nuestra primer cita ‚òï",
    message:"Perd√≥n por decir eso ese d√≠a, espero esto lo compense jaja.",
    camImg:"models/regalo3.png" }
];

const FINAL_DESTINATION = {
  lat: 20.6465, lng: -100.3564,
  text: "Has reunido todos los regalos. Hay una √∫ltima sorpresa esperando por ti‚Ä¶ ¬øVienes? üíõ",
  linkText: "Navegar al destino final",
};

// Cup√≥n √∫nico por regalo atrapado
const REWARDS = {
  plaza:   { title:"Cup√≥n de caf√© ‚òï", text:"Vale por un caf√© juntos en Puerta la Victoria. (Solo v√°lido con besos incluidos)", img:"models/cupon_plaza.png", url:"#plaza" },
  alameda: { title:"Cup√≥n roles üå≥", text:"Vale por roles de canela: comprados o preparados por m√≠.", img:"models/cupon_alameda.png", url:"#alameda" },
  maniatica: { title:"Cup√≥n baile üé¨", text:"Vale por una cita a bailar: t√∫ eliges el lugar y el ritmo, yo invito.", img:"models/cupon_maniatica.png", url:"#maniatica" }
};

const DIFFICULTY = { cardSpeedMin: 80, cardSpeedMax: 180, wobbleAmp: 6, wobbleFreq: 2.2 };
const STORAGE_KEY = "rqg_progress_v1";
let found = new Set(JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]"));

/* ========= GALER√çA DE CUPONES ========= */
const GALLERY_KEY = "rqg_coupons_gallery_v1";  // [{id,title,text,dataUrl,savedAt}]
function loadGallery(){
  try { return JSON.parse(localStorage.getItem(GALLERY_KEY) || "[]"); }
  catch{ return []; }
}
function saveGallery(arr){ localStorage.setItem(GALLERY_KEY, JSON.stringify(arr)); }
function blobToDataURL(blob){
  return new Promise(res=>{
    const r = new FileReader();
    r.onload = ()=> res(r.result);
    r.readAsDataURL(blob);
  });
}
async function saveCouponToGallery(couponId, r){
  const gal = loadGallery();
  if (gal.some(x => x.id === couponId)) return; // evita duplicados por id
  try{
    const resp = await fetch(r.img, { cache:"no-cache" });
    const blob = await resp.blob();
    const dataUrl = await blobToDataURL(blob);
    gal.push({ id: couponId || ("c_"+Date.now()), title: r.title || "Cup√≥n", text: r.text || "", dataUrl, savedAt: new Date().toISOString() });
    saveGallery(gal);
    renderGallery();
    showMsg("Cup√≥n guardado en 'Mis cupones' ‚ù§Ô∏è");
  }catch(err){ console.error("No se pudo guardar en galer√≠a:", err); }
}
function renderGallery(){
  const gal = loadGallery();
  const card = document.getElementById("galleryCard");
  const list = document.getElementById("galleryList");
  const info = document.getElementById("galleryInfo");
  if (!card || !list || !info) return;
	 
				
   
 
	   
	   
			   
			   
			   
		   

  info.textContent = `${gal.length} guardado${gal.length===1?"":"s"}`;
  card.style.display = gal.length ? "block" : "none";
  list.innerHTML = "";

  gal.forEach(item => {
    const wrap = document.createElement("div");
    wrap.className = "pill";
    wrap.style.display = "grid";
    wrap.style.gridTemplateColumns = "80px 1fr auto";
    wrap.style.alignItems = "center";
    wrap.style.gap = "10px";
    wrap.innerHTML = `
      <img src="${item.dataUrl}" alt="${item.title}" style="width:80px;height:auto;border-radius:8px;border:1px solid #2a2a3a">
      <div>
        <div style="font-weight:700">${item.title}</div>
        <div style="font-size:12px;opacity:.8">${new Date(item.savedAt).toLocaleString()}</div>
        <div style="font-size:12px;opacity:.9;margin-top:4px">${item.text}</div>
      </div>
      <div class="btns" style="flex-direction:column;gap:6px">
        <button class="btn secondary" data-del="${item.id}">Eliminar</button>
      </div>
    `;
    list.appendChild(wrap);
  });

  // Delegaci√≥n para eliminar uno
  list.onclick = (e)=>{
    const btn = e.target.closest("button[data-del]");
    if (!btn) return;
    const id = btn.getAttribute("data-del");
    const updated = loadGallery().filter(x => x.id !== id);
    saveGallery(updated);
    renderGallery();
  };
}
// Bot√≥n "Borrar todo"
const clearBtn = document.getElementById("clearGalleryBtn");
if (clearBtn) {
  clearBtn.addEventListener("click", ()=>{
    if (confirm("¬øBorrar todos los cupones guardados?")) {
      saveGallery([]);
      renderGallery();
    }
  });
}
// Render inicial
renderGallery();

/* ========= UTILIDADES ========= */
function showMsg(text, ms=3200){
  const bar = document.getElementById('msgBar');
  bar.textContent = text; bar.style.display = 'block';
  clearTimeout(showMsg._t); showMsg._t = setTimeout(()=> bar.style.display='none', ms);
}
function fmtMeters(m){ if (m==null) return ""; if (m<1000) return `${Math.round(m)} m`; const km=m/1000; return km>=10?`${Math.round(km)} km`:`${km.toFixed(1)} km`; }
function haversine(lat1, lon1, lat2, lon2) {
  const R=6371000, toRad=x=>x*Math.PI/180, dLat=toRad(lat2-lat1), dLon=toRad(lon2-lon1);
  const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
  return 2*R*Math.asin(Math.sqrt(a));
}
function rand(min,max){ return Math.random()*(max-min)+min; }

/* ========= MAPA (plano navegaci√≥n) ========= */
const map = new mapboxgl.Map({
  container: 'map',
  style: 'mapbox://styles/mapbox/navigation-day-v1',
  center: [-100.389, 20.595],
  zoom: 15.5,
  pitch: 60,
  bearing: -20,
  antialias: true
});
map.addControl(new mapboxgl.NavigationControl({ visualizePitch: true }), 'top-right');

map.on('style.load', () => {
  addStopMarkers();
});
				   
   

						   
function addStopMarkers(){
  STOPS.forEach(s => {
    const el = document.createElement('div');
    el.className = 'marker marker-stop';
    el.innerHTML = `
      <svg class="ico" width="22" height="22" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M12 21s-7-4.438-7-10a7 7 0 1 1 14 0c0 5.562-7 10-7 10Z" fill="#fff"/>
        <path d="M12 8.2c-1.657 0-3 1.343-3 3 0 2.25 3 4.8 3 4.8s3-2.55 3-4.8c0-1.657-1.343-3-3-3Z" fill="#ff5a7a"/>
      </svg>`;
    new mapboxgl.Marker(el, {anchor:'center'})
      .setLngLat([s.lng, s.lat])
																			   
      .setPopup(new mapboxgl.Popup({ offset: 18, className: 'popup-darktext' })
        .setHTML(`<div><strong>${s.name || s.title}</strong><div class="popup-sub">${s.title}</div></div>`))
      .addTo(map);
  });

  const elf = document.createElement('div');
  elf.className = 'marker marker-final';
  elf.innerHTML = `
    <svg class="ico" width="22" height="22" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
      <path d="M12 2l2.952 6.006L22 8.764l-5 4.873L18.902 22 12 18.4 5.098 22 7 13.637l-5-4.873 7.048-1.758L12 2Z" fill="#fff"/>
    </svg>`;
  new mapboxgl.Marker(elf, {anchor:'center'})
    .setLngLat([FINAL_DESTINATION.lng, FINAL_DESTINATION.lat])
					
    .setPopup(new mapboxgl.Popup({ offset: 18, className: 'popup-darktext' })
      .setHTML('<div><strong>Destino final üíõ</strong><div class="popup-sub">¬°No veas el spoiler hasta juntar todo!</div></div>'))
    .addTo(map);
}

/* ========= RUTA ========= */
let routeSourceAdded = false;
function drawRoute(geojson){
  if (!routeSourceAdded){
    map.addSource('route', { type:'geojson', data: geojson });
    map.addLayer({ id:'route-line', type:'line', source:'route', paint:{ 'line-color':'#ff5a7a','line-width':6,'line-opacity':0.9 } });
    routeSourceAdded = true;
  } else { map.getSource('route').setData(geojson); }
}
function getNextStop(){ for (const s of STOPS) if (!found.has(s.id)) return s; return null; }
async function fetchAndDrawRoute(fromLngLat, toLngLat){
  if (!toLngLat) return;
  const url = `https://api.mapbox.com/directions/v5/mapbox/walking/${fromLngLat[0]},${fromLngLat[1]};${toLngLat[0]},${toLngLat[1]}?geometries=geojson&overview=full&access_token=${mapboxgl.accessToken}`;
   
   
	  
								 
  try{ const res = await fetch(url); const data = await res.json();
									   
    if (data.routes && data.routes[0]){ const gj = { type:'FeatureCollection', features:[{ type:'Feature', geometry:data.routes[0].geometry, properties:{} }] }; drawRoute(gj);} }
					
	 
  catch(e){ console.warn('No se pudo obtener la ruta', e); }
}

/* ========= UI PARADAS ========= */
const stopsList = document.getElementById('stopsList');
function renderStops(distanceMap = {}) {
  stopsList.innerHTML = "";
  STOPS.forEach(s => {
    const isFound = found.has(s.id);
    const d = distanceMap[s.id];
    const canCatch = d != null && d <= s.radius;

    const div = document.createElement('div');
    div.className = "card stop" + (isFound ? " found" : "");
    const camBtn = canCatch
      ? `<button class="btn secondary" data-cam="${s.id}">Ver en c√°mara</button>`
      : `<button class="btn secondary" disabled title="Ac√©rcate para usar c√°mara">Ver en c√°mara</button>`;

    div.innerHTML = `
      <div>
        <div><strong>${s.title}</strong></div>
        <div class="meta">Radio: ${s.radius} m ¬∑ ${d!=null?`Distancia: ${fmtMeters(d)}`:""}</div>
        <div class="meta">${isFound ? "‚úÖ regalo atrapado" : "Pendiente"}</div>
        ${isFound ? `<div class="pill">${s.message}</div>` : ""}
      </div>
      <div class="btns">
        ${camBtn}
        <button data-id="${s.id}" class="btn" ${isFound || !canCatch ? "disabled":""}>
          Atrapar regalo
        </button>
      </div>`;
    stopsList.appendChild(div);
  });

  const got = found.size, total = STOPS.length;
  document.getElementById('progressText').textContent = `${got} de ${total} regalos`;
  document.getElementById('bar').style.width = (total? (100*got/total):0) + "%";

  const showFinal = (found.size === STOPS.length);
  const finalCard = document.getElementById('finalCard');
  finalCard.style.display = showFinal ? "block" : "none";
  if (showFinal) {
    document.getElementById('finalMsg').textContent = FINAL_DESTINATION.text;
    const finalUrlApple = `http://maps.apple.com/?daddr=${FINAL_DESTINATION.lat},${FINAL_DESTINATION.lng}&dirflg=d`;
    const finalUrlGoogle = `https://www.google.com/maps/dir/?api=1&destination=${FINAL_DESTINATION.lat},${FINAL_DESTINATION.lng}`;
    const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
    const link = document.getElementById('finalLink');
    link.textContent = FINAL_DESTINATION.linkText;
    link.href = isIOS ? finalUrlApple : finalUrlGoogle;
  }
}
renderStops();

									
function buildRoutePreview(){
  const list = STOPS.map((s, i)=> `${i+1}¬™ Parada: ${s.name || s.title}`).join(' ¬∑ ');
  const el = document.getElementById('routePreview');
  if (el) el.textContent = `Ruta de hoy: ${list}`;
}
buildRoutePreview();

/* ========= eventos lista ========= */
stopsList.addEventListener('click', (e)=>{
  const camBtn = e.target.closest('button[data-cam]');
  if (camBtn){
    const stopId = camBtn.getAttribute('data-cam');
    const stop = STOPS.find(x=>x.id===stopId);
    if (stop) openCamera(stop);
    return;
  }
  const btn = e.target.closest('button[data-id]');
  if(!btn) return;
  const id = btn.getAttribute('data-id');
  if (found.has(id)) return;
  found.add(id);
  localStorage.setItem(STORAGE_KEY, JSON.stringify([...found]));
  btn.textContent = "¬°Capturada!";
  btn.disabled = true;
  renderStops(lastDistances);
																					
  showReward(id);
});

																		   

													  
										   
					  
										  
  

// Reinicio progreso
const resetBtn = document.getElementById('resetBtn');
resetBtn.addEventListener('click', ()=>{
  localStorage.removeItem(STORAGE_KEY);
  found = new Set();
  renderStops(lastDistances);
  showMsg("Progreso reiniciado. üéØ");
});

/* ========= GPS + ruta + MODO CAMINATA + AVATAR ========= */
let watchId = null;
let lastDistances = {};
let myMarker = null;
let walkingMode = false;
let lastPos = null;
let headingFromCompass = null;
let promptedNear = new Set(); // para no spamear avisos cerca de cada parada

function applyAvatarMotion(speedMps, bearingDeg){
  const img = myMarker?.getElement().querySelector('.avatar');
  if (!img) return;
  if (typeof bearingDeg === 'number') img.style.setProperty('--rot', `${bearingDeg}deg`);
  if (speedMps > 0.6) { img.classList.add('walk'); img.classList.remove('idle'); const step = Math.max(260, Math.min(700, 1200/(speedMps + 0.5))); img.style.setProperty('--stepDur', `${Math.round(step)}ms`); }
															
																	 
																
 
		  
  else { img.classList.add('idle'); img.classList.remove('walk'); img.style.removeProperty('--stepDur'); }
   
}

const walkBtn = document.getElementById('walkBtn');
walkBtn.addEventListener('click', async ()=>{
  walkingMode = !walkingMode;
  walkBtn.textContent = walkingMode ? 'Modo caminata: ON' : 'Modo caminata';
  try{
    if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
      const res = await DeviceOrientationEvent.requestPermission();
      if (res !== 'granted') showMsg("Sin permiso de br√∫jula. Usar√© direcci√≥n de movimiento.");
    }
  }catch(_){}}
);

window.addEventListener('deviceorientation', (e)=>{
  const ios = (typeof e.webkitCompassHeading === 'number') ? e.webkitCompassHeading : null;
  if (ios != null) headingFromCompass = ios;
  else if (e.absolute === true && typeof e.alpha === 'number') headingFromCompass = 360 - e.alpha;
}, { passive:true });

function updateDistances(pos){
  const { latitude:lat, longitude:lng } = pos.coords;
  const nowTs = (typeof pos.timestamp==='number') ? pos.timestamp : Date.now();

  // Crear/actualizar avatar marker
  if (!myMarker){
    const wrap = document.createElement('div');
    wrap.className = 'avatar-wrap';
    const img = document.createElement('img');
    img.src = 'models/avatar.png';
    img.alt = 'Yo';
    img.className = 'avatar idle';
    wrap.appendChild(img);

    myMarker = new mapboxgl.Marker(wrap, { anchor: 'center', rotationAlignment: 'map' })
      .setLngLat([lng, lat]).addTo(map);

    map.easeTo({ center:[lng, lat], zoom:16, duration:600 });
  } else { myMarker.setLngLat([lng, lat]); }

  // Distancias + UI
  const d = {}; STOPS.forEach(s => d[s.id] = haversine(lat,lng,s.lat,s.lng));
  lastDistances = d; renderStops(d);

  // Aviso autom√°tico al estar cerca
  STOPS.forEach(s=>{
    const inside = d[s.id] != null && d[s.id] <= s.radius;
    if (inside && !found.has(s.id) && !promptedNear.has(s.id)){
      promptedNear.add(s.id);
      askCatchConfirm(s);
    }
    if (!inside && promptedNear.has(s.id) && d[s.id] > s.radius * 1.2){
      promptedNear.delete(s.id);
    }
  });

  // Ruta hacia la siguiente parada
  const next = getNextStop();
  if (next){
    const me = [lng, lat], dest = [next.lng, next.lat];
    clearTimeout(updateDistances._t);
    updateDistances._t = setTimeout(()=> fetchAndDrawRoute(me, dest), 300);
  }

  // Rumbo
  let bearing = headingFromCompass;
  if (bearing == null && lastPos){
    const dy = lat - lastPos.lat, dx = lng - lastPos.lng;
    if (Math.abs(dx)+Math.abs(dy) > 1e-7)
      bearing = (Math.atan2(dx, dy) * 180/Math.PI + 360) % 360;
  }
  if (bearing == null && next){
    const toRad = d=>d*Math.PI/180, toDeg=r=>r*180/Math.PI;
    const œÜ1=toRad(lat), œÜ2=toRad(next.lat), ŒîŒª=toRad(next.lng-lng);
    const y=Math.sin(ŒîŒª)*Math.cos(œÜ2);
    const x=Math.cos(œÜ1)*Math.sin(œÜ2)-Math.sin(œÜ1)*Math.cos(œÜ2)*Math.cos(ŒîŒª);
    bearing = (toDeg(Math.atan2(y,x))+360)%360;
  }

  // Velocidad (m/s)
  let speed = 0;
  if (lastPos?.ts) {
    const dt = Math.max(0.2, (nowTs - lastPos.ts)/1000);
    const dist = haversine(lat, lng, lastPos.lat, lastPos.lng);
    speed = dist / dt;
  }

  applyAvatarMotion(speed, bearing);

  if (walkingMode){
    map.easeTo({ center: [lng, lat], zoom: 18.3, pitch: 55, bearing: (typeof bearing === 'number') ? bearing : map.getBearing(), duration: 600 });
  }

  lastPos = { lat, lng, ts: nowTs };
}

function startGPS(){
  if(!('geolocation' in navigator)){ alert("Tu navegador no permite geolocalizaci√≥n."); return; }
  if (watchId!=null) return;
  watchId = navigator.geolocation.watchPosition(updateDistances, (err)=>{
    console.warn(err); showMsg("No se pudo obtener tu ubicaci√≥n. Revisa permisos.");
  }, { enableHighAccuracy:true, maximumAge:1000, timeout:15000 });
}

document.getElementById('startBtn').addEventListener('click', startGPS);

/* ========= Pantalla completa (con fallback para iOS) ========= */
const fsBtn = document.getElementById('fsBtn');
const fsExitBtn = document.getElementById('fsExitBtn');
const mapEl = document.getElementById('map');

function enterNativeFullscreen(){ try{ const el = mapEl; const req = el.requestFullscreen || el.webkitRequestFullscreen || el.msRequestFullscreen; if (req) { req.call(el); return true; } }catch(_){} return false; }
function exitNativeFullscreen(){ try{ const ex = document.exitFullscreen || document.webkitExitFullscreen || document.msExitFullscreen; if (ex) { ex.call(document); return true; } }catch(_){} return false; }
function enterCssFullscreen(){ document.body.classList.add('is-fs'); fsExitBtn.style.display = 'block'; map.resize(); }
function exitCssFullscreen(){ document.body.classList.remove('is-fs'); fsExitBtn.style.display = 'none'; map.resize(); }

fsBtn.addEventListener('click', ()=>{ const ok = enterNativeFullscreen(); if (!ok) enterCssFullscreen(); });
fsExitBtn.addEventListener('click', ()=> exitCssFullscreen());
['fullscreenchange','webkitfullscreenchange','msfullscreenchange'].forEach(ev=>{
	
									 
  document.addEventListener(ev, ()=>{ const inFs = !!(document.fullscreenElement || document.webkitFullscreenElement || document.msFullscreenElement); if (inFs){ fsExitBtn.style.display = 'none'; map.resize(); } else { exitCssFullscreen(); } });
});

/* ========= C√ÅMARA + MINI-JUEGO ========= */
const camOverlay = document.getElementById('camOverlay');
const camVideo   = document.getElementById('camVideo');
const camCanvas  = document.getElementById('camCanvas');
const closeCam   = document.getElementById('closeCam');
const throwHintBtn = document.getElementById('throwHintBtn');

let camStream = null, currentStop = null;
let W=0,H=0,DPR=Math.max(1,window.devicePixelRatio||1);
const ctx = camCanvas.getContext('2d');

const placeholderDataURL = "data:image/svg+xml;charset=utf8," + encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" width="640" height="960"><rect width="100%" height="100%" fill="#222"/><text x="50%" y="50%" fill="#fff" font-size="28" text-anchor="middle">Imagen no encontrada</text></svg>');

const game = { card:null, ball:null, gravity:1800, swipe:{active:false,sx:0,sy:0,ex:0,ey:0}, running:false, last:0 };

function loadImage(src){
  return new Promise((resolve)=>{
    const im=new Image();
    im.onload=()=>resolve(im);
    im.onerror=()=>{ console.warn("No se pudo cargar imagen:", src); showMsg("No se encontr√≥ el regalo: " + src); const ph=new Image(); ph.onload=()=>resolve(ph); ph.src=placeholderDataURL; };
    im.src=src;
  });
}
function resizeCanvas(){
  const rect = camVideo.getBoundingClientRect();
  W=Math.floor(rect.width); H=Math.floor(rect.height||W*1.6);
  camCanvas.width=Math.floor(W*DPR); camCanvas.height=Math.floor(H*DPR);
  camCanvas.style.width=W+'px'; camCanvas.style.height=H+'px';
  ctx.setTransform(DPR,0,0,DPR,0,0);
}

async function openCamera(stop){
  currentStop = stop;
  camOverlay.style.display = "block";
  try{
    camStream = await navigator.mediaDevices.getUserMedia({ video:{facingMode:"environment"}, audio:false });
    camVideo.srcObject = camStream; await camVideo.play();
    camVideo.addEventListener('loadedmetadata', resizeCanvas, { once:true });
  }catch(err){ console.error(err); showMsg("No se pudo acceder a la c√°mara. Usa HTTPS y permite acceso."); closeCamera(); return; }

  resizeCanvas(); window.addEventListener('resize', resizeCanvas);

  const cardImg = await loadImage(stop.camImg || "models/regalo1.png");
  const cardW = Math.min(W*0.42, 320), cardH = cardW*1.5;
  const speed = rand(DIFFICULTY.cardSpeedMin, DIFFICULTY.cardSpeedMax);
  const angle = rand(0, Math.PI*2);
  game.card = {x:(W-cardW)/2, y:H*0.22, w:cardW, h:cardH, img:cardImg, vx:Math.cos(angle)*speed, vy:Math.sin(angle)*speed, t:0};

  const r = Math.max(22, W*0.055);
  game.ball = {x: W*0.5, y: H*0.82, r, vx:0, vy:0, flying:false};

  game.running = true; game.last = 0; requestAnimationFrame(loop);
  camCanvas.addEventListener('pointerdown', onDown);
  camCanvas.addEventListener('pointermove', onMove);
  camCanvas.addEventListener('pointerup',   onUp);
}

function closeCamera(){
  game.running=false;
  camCanvas.removeEventListener('pointerdown', onDown);
  camCanvas.removeEventListener('pointermove', onMove);
  camCanvas.removeEventListener('pointerup',   onUp);
  window.removeEventListener('resize', resizeCanvas);
  camOverlay.style.display = "none";
  camVideo.pause();
  if (camStream){ camStream.getTracks().forEach(t=>t.stop()); camStream=null; }
  currentStop=null;
}

function onDown(e){
  const rect = camCanvas.getBoundingClientRect();
  const x=e.clientX-rect.left, y=e.clientY-rect.top;
  const b=game.ball; if(!b) return;
  const dx=x-b.x, dy=y-b.y;
  if(dx*dx+dy*dy <= b.r*b.r*1.8){ game.swipe = {active:true,sx:x,sy:y,ex:x,ey:y}; }
}
function onMove(e){ if(!game.swipe.active) return; const rect = camCanvas.getBoundingClientRect(); game.swipe.ex = e.clientX-rect.left; game.swipe.ey = e.clientY-rect.top; }
function onUp(){
  const b=game.ball; if(!game.swipe.active||!b||b.flying){ game.swipe.active=false; return; }
  const dx=game.swipe.ex-game.swipe.sx, dy=game.swipe.ey-game.swipe.sy;
  const mag=Math.hypot(dx,dy); if(mag<12){ game.swipe.active=false; return; }
  const ang=Math.atan2(dy,dx), speed=Math.min(1,mag/220)*1500;
  b.vx=Math.cos(ang)*speed; b.vy=Math.sin(ang)*speed; b.flying=true; game.swipe.active=false;
}

function loop(ts){
  if(!game.running) return;
  if(!game.last) game.last = ts;
  const dt = Math.min(0.033, (ts-game.last)/1000); game.last = ts;
  const b=game.ball, t=game.card;

  if(t){
    t.t += dt; t.x += t.vx*dt; t.y += t.vy*dt;
    const wobble = Math.sin(t.t * (Math.PI*2*DIFFICULTY.wobbleFreq)) * DIFFICULTY.wobbleAmp;
    if(t.x<6){ t.x=6; t.vx*=-1; } if(t.x+t.w>W-6){ t.x=W-6-t.w; t.vx*=-1; }
    if(t.y<6){ t.y=6; t.vy*=-1; } if(t.y+t.h>H*0.9){ t.y=H*0.9-t.h; t.vy*=-1; }
    const drawY = t.y + wobble;
    ctx.clearRect(0,0,W,H);
    ctx.drawImage(t.img, t.x, drawY, t.w, t.h);
  } else { ctx.clearRect(0,0,W,H); }

  if(b){
    if(b.flying){ b.vy += game.gravity*dt; b.x += b.vx*dt; b.y += b.vy*dt; }
    if(b.x<b.r){ b.x=b.r; b.vx*=-0.4; }
    if(b.x>W-b.r){ b.x=W-b.r; b.vx*=-0.4; }
    if(b.y>H-b.r){ b.y=H-b.r; b.vy*=-0.35; b.vx*=0.96; if(Math.abs(b.vy)<60){ b.vy=0; b.flying=false; } }
    ctx.beginPath(); ctx.arc(b.x,b.y,b.r,0,Math.PI*2); ctx.fillStyle="#ff5a7a"; ctx.fill();
    ctx.save(); ctx.translate(b.x,b.y-2); ctx.fillStyle="#fff"; heartPath(ctx,b.r*0.38); ctx.fill(); ctx.restore();
    ctx.beginPath(); ctx.arc(b.x-b.r*0.35,b.y-b.r*0.35,b.r*0.22,0,Math.PI*2); ctx.fillStyle="rgba(255,255,255,.5)"; ctx.fill();
  }

  if(game.swipe.active){ ctx.strokeStyle="rgba(255,255,255,.5)"; ctx.lineWidth=2; ctx.beginPath(); ctx.moveTo(game.swipe.sx,game.swipe.sy); ctx.lineTo(game.swipe.ex,game.swipe.ey); ctx.stroke(); }

  if(b && t && b.x>t.x && b.x<t.x+t.w && b.y>t.y && b.y<t.y+t.h){ onCaught(); return; }
  requestAnimationFrame(loop);
}

function heartPath(ctx, s){ ctx.beginPath(); ctx.moveTo(0, s*0.6); ctx.bezierCurveTo(-s, -s*0.2, -s*0.9, -s, 0, -s*0.6); ctx.bezierCurveTo(s*0.9, -s, s, -s*0.2, 0, s*0.6); }

function onCaught(){
															  
  const wonId = currentStop?.id;
  if (wonId && !found.has(wonId)){
    found.add(wonId);
    localStorage.setItem(STORAGE_KEY, JSON.stringify([...found]));
  }
  setTimeout(()=>{ closeCamera(); renderStops(lastDistances); showReward(wonId); }, 120);
}

										  
function askCatchConfirm(stop){
  const text = `Est√°s cerca de "${stop.name || stop.title}". ¬øQuieres atrapar el regalo ahora?`;
  if (confirm(text)) openCamera(stop); else showMsg('Puedes abrir la c√°mara desde la lista cuando quieras.');
}

/* ========= MODAL DE CUP√ìN ========= */
const rewardModal = document.getElementById('rewardModal');
const rewardTitle = document.getElementById('rewardTitle');
const rewardText  = document.getElementById('rewardText');
const rewardImg   = document.getElementById('rewardImg');
const rewardUseBtn= document.getElementById('rewardUseBtn');
const rewardSavePhotosBtn = document.getElementById('rewardSavePhotosBtn');
const rewardCloseBtn = document.getElementById('rewardCloseBtn');

async function saveImageToPhotos(r, defaultName){
  try{
									 
    const resp = await fetch(r.img, { cache: "no-cache" });
    const blob = await resp.blob();
    const fileType = blob.type || "image/png";
    const file = new File([blob], defaultName || "cupon.png", { type: fileType });

											   
    const canShareFiles = !!(navigator.canShare && navigator.canShare({ files: [file] }));
    if (canShareFiles){
      await navigator.share({ files: [file], title: r.title || "Cup√≥n", text: r.text || "" });
					  
								   
						  
		 
																				   
      showMsg('En la hoja de iOS toca "Guardar imagen" para enviarla a tu galer√≠a.');
    } else {
																  
      window.open(r.img, "_blank");
      showMsg('Tu navegador no permite enviar a Fotos. Abre y toca Compartir ‚Üí Guardar imagen.');
    }
  }catch(err){
    console.error("No se pudo abrir la hoja de compartir:", err);
    window.open(r.img, "_blank");
    showMsg('No se pudo lanzar compartir. Abriendo imagen para que puedas guardarla.');
  }
}


function showReward(id){
  const r = REWARDS[id] || { title:"¬°Premio!", text:"Cup√≥n sorpresa desbloqueado.", img:"models/cupon_default.png", url:"#cup" };
  rewardTitle.textContent = r.title;
  rewardText.textContent  = r.text;
  rewardImg.src = r.img;

  // Guardar AUTOM√ÅTICO en galer√≠a interna
  saveCouponToGallery(id, r);

  // Preparar descarga directa
  rewardUseBtn.textContent = 'Usar cup√≥n';
  const filenameFromPath = (p)=>{
    try{ const clean=p.split('#')[0].split('?')[0]; const name=clean.substring(clean.lastIndexOf('/')+1)||'cupon.png'; return name; }catch(_){ return 'cupon.png'; }
  };
  const defaultName = filenameFromPath(r.img) || `cupon_${id||'amor'}.png`;

  rewardUseBtn.href = r.img;
  rewardUseBtn.setAttribute('download', defaultName);

  rewardUseBtn.onclick = async (ev)=>{
    ev.preventDefault();
    try{
      const res = await fetch(r.img, {cache:'no-cache'});
      const blob = await res.blob();
      const a = document.createElement('a');
      const url = URL.createObjectURL(blob);
      a.href = url;
      a.download = defaultName;
      document.body.appendChild(a);
      a.click();
      a.remove();
      setTimeout(()=> URL.revokeObjectURL(url), 1200);
      showMsg('Cup√≥n descargado üì•');
    }catch(err){
      console.error('No se pudo descargar, abriendo imagen:', err);
      window.open(r.img, '_blank');
      showMsg('Abriendo el cup√≥n‚Ä¶ si no se descarga, guarda la imagen manualmente.');
    }
  };

  // Guardar en Fotos (iOS/soporte Web Share Level 2)
  rewardSavePhotosBtn.onclick = async (ev)=>{
    ev.preventDefault();
    await saveImageToPhotos(r, defaultName);
  };

  rewardModal.style.display = 'flex';
}
rewardCloseBtn.addEventListener('click', ()=> rewardModal.style.display='none');
rewardModal.querySelector('.backdrop').addEventListener('click', ()=> rewardModal.style.display='none');

/* ======== Flujo de inicio ======== */
const landing = document.getElementById('landingOverlay');
const landingStartBtn = document.getElementById('landingStartBtn');
const safety = document.getElementById('safetyOverlay');
const safetyOkBtn = document.getElementById('safetyOkBtn');
const uiPanel = document.getElementById('uiPanel');

function setPreGameUI(){ uiPanel.style.display = 'none'; document.getElementById('map').style.height = '100vh'; }
setPreGameUI();

landingStartBtn.addEventListener('click', ()=>{ const ok = enterNativeFullscreen(); if (!ok) enterCssFullscreen(); safety.style.display = 'flex'; });

safetyOkBtn.addEventListener('click', ()=>{
  safety.style.display = 'none';
  landing.style.display = 'none';
  uiPanel.style.display = '';
  startGPS();
  const firstRoute = STOPS.map((s,i)=> `${i+1}) ${s.name || s.title}`).join('  ');
  showMsg(`Paradas: ${firstRoute}`, 6000);
});

// Ayuda
const closeCamBtn = document.getElementById('closeCam');
closeCamBtn.addEventListener('click', closeCamera);
const throwHintBtn2 = document.getElementById('throwHintBtn');
throwHintBtn2.addEventListener('click', ()=> showMsg('Toca cerca de la bola y desliza hacia el regalo. Si fallas, intenta con otra direcci√≥n.'));

 // Extra: muestra errores JS en pantalla
window.addEventListener('error', (e)=>{ try{ showMsg('JS: ' + (e.message||'error')); }catch(_){ console.log(e); } });
</script>
</body>
</html>
